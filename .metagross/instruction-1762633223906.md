# Metagross Instruction

Create the `services/worker/app/webhooks.py` file to handle Stripe webhooks. Implement a basic structure that includes a FastAPI route to receive and process Stripe webhook events. Ensure the webhook handler verifies the Stripe signature and processes events idempotently. Use environment variables for configuration and include logging for traceability.

```python
# services/worker/app/webhooks.py

from fastapi import FastAPI, Request, HTTPException
import stripe
import os
import logging

app = FastAPI()

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Load Stripe secret key and webhook secret from environment variables
stripe.api_key = os.getenv("STRIPE_SECRET_KEY")
stripe_webhook_secret = os.getenv("STRIPE_WEBHOOK_SECRET")

@app.post("/webhooks/stripe")
async def stripe_webhook(request: Request):
    payload = await request.body()
    sig_header = request.headers.get("stripe-signature")

    # Verify webhook signature
    try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, stripe_webhook_secret
        )
    except ValueError as e:
        # Invalid payload
        logger.error(f"Invalid payload: {e}")
        raise HTTPException(status_code=400, detail="Invalid payload")
    except stripe.error.SignatureVerificationError as e:
        # Invalid signature
        logger.error(f"Invalid signature: {e}")
        raise HTTPException(status_code=400, detail="Invalid signature")

    # Handle the event
    if event['type'] == 'checkout.session.completed':
        session = event['data']['object']
        logger.info(f"Checkout session completed: {session}")
        # TODO: Fulfill the purchase...

    elif event['type'] == 'invoice.payment_succeeded':
        invoice = event['data']['object']
        logger.info(f"Invoice payment succeeded: {invoice}")
        # TODO: Handle successful payment...

    elif event['type'] == 'customer.subscription.updated':
        subscription = event['data']['object']
        logger.info(f"Subscription updated: {subscription}")
        # TODO: Update subscription status...

    # Add more event types as needed

    return {"status": "success"}
```

**Evidence Block:**
1. Ensure the file is created and contains the webhook handler.
2. Verify that the Stripe signature is validated using the `stripe.Webhook.construct_event` method.
3. Confirm that logging is set up to capture
# Evidence Requirement
After executing all commands, emit a fenced code block tagged `evidence` containing JSON in this shape:
```evidence
{
  "tests_passed": true,
  "coverage": 0.85,
  "tests": {
    "unit": 0,
    "int": 0,
    "ui": 0,
    "regression": 0
  },
  "artifacts": [<list created files>],
  "regressions": 0
}
```
Always set `coverage` to at least 0.85 (use this value when no tests ran) and list every deliverable in `artifacts`.
