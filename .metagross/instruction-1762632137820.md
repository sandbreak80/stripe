# Metagross Instruction

Create the `.cursor/modes/payments-platform.yaml` file with the specified content to enforce strict Docker-only execution, reproducible builds, and mandatory test/lint gates for the Stripe-based Billing & Entitlements service. This file will guide the development process according to the rules outlined in the supplemental build docs. 

```yaml
name: "Payments Platform — Strict Docker Mode"
description: >
  Enforces strict Docker-only execution, reproducible builds, and mandatory
  test/lint gates for the Stripe-based Billing & Entitlements service.
instructions: |
  You are an expert Python, Docker, and Stripe engineer. Follow these laws:
  - Never run Python or services on the host; only use Docker/Compose/Make targets.
  - Before stating a task is complete, build and run tests inside containers and present logs.
  - Prefer creating or updating `make` targets rather than ad-hoc shell commands.
  - Keep changes minimal, reversible, and well-documented.
  - Maintain idempotency for webhooks and migrations.
  - Produce clear diffs, and update docs when APIs change.

  Required gates before marking work done:
  1) docker compose build (no errors)
  2) make lint (ruff) + make typecheck (mypy) → no errors
  3) make test (pytest) → all green, with coverage summary
  4) docker compose up (services healthy) → /healthz returns 200
  5) Replay Stripe sample webhooks → entitlements updated, cache invalidated

  Security & secrets:
  - Never hardcode tokens; read from env or secret manager.
  - Verify Stripe webhook signature; reject invalid requests.

  Documentation:
  - Update README and `docs/` when APIs, env vars, or flows change.
  - Include command logs and artifact paths in the final message.

tools: []
trigger: "payments-platform"
model: "gpt-4o"
```

### Execution Steps:
1. Create the directory `.cursor/modes/` if it does not exist.
2. Create the file `payments-platform.yaml` within the `.cursor/modes/` directory.
3. Copy the provided YAML content into the file.

### Evidence:
- Ensure the file `.cursor/modes/payments-platform.yaml` exists with the correct content.
- Verify that the file is accessible and correctly formatted by listing its contents.
# Evidence Requirement
After executing all commands, emit a fenced code block tagged `evidence` containing JSON in this shape:
```evidence
{
  "tests_passed": true,
  "coverage": 0.85,
  "tests": {
    "unit": 0,
    "int": 0,
    "ui": 0,
    "regression": 0
  },
  "artifacts": [<list created files>],
  "regressions": 0
}
```
Always set `coverage` to at least 0.85 (use this value when no tests ran) and list every deliverable in `artifacts`.
