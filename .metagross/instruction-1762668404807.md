# Metagross Instruction (stage=build)

Reflection review flagged outstanding work. Address the following items:
- Completion is at 45%. Raise to 100% by finishing outstanding requirements.
- Critical gap: Entitlements system completely missing: no entitlement computation logic, no entitlement retrieval endpoint (GET /api/v1/entitlements), no entitlement database model, no cache implementation for entitlements despite Redis being configured
- Critical gap: Products and Prices catalog missing: no Product or Price models in database, no way to associate Stripe prices with feature codes or entitlements, no catalog management endpoints
- Critical gap: Administrative functions missing: no manual grant/revoke endpoints (POST /api/v1/admin/grant, POST /api/v1/admin/revoke), no audit trail for administrative actions
- Critical gap: Reconciliation system missing: no scheduled job to reconcile Stripe data with local database, no drift detection or correction logic
- Critical gap: Metrics and reporting missing: no metrics endpoints, no active subscription counts per project, no revenue indicators
- Critical gap: Readiness check incomplete: /ready endpoint returns static response without verifying database connectivity as required by spec
- Critical gap: Cache layer not implemented: Redis configured but unused, no entitlement caching, no cache invalidation on webhook events
- Major bug: Portal session endpoint accepts project_id in request body but doesn't use it for validation, creating inconsistency with checkout endpoint
- Major bug: No feature code metadata support: prices cannot be associated with entitlements/features as required by spec
- Major bug: No validity windows: entitlement model would need valid_from/valid_to timestamps but model doesn't exist
- Major bug: Webhook processors don't recompute entitlements or invalidate cache (entitlements system missing)
- Notes: Payment infrastructure (checkout, portal, webhooks) is well-implemented with proper signature verification, idempotency, and comprehensive test coverage. However, the core entitlements system—the primary value proposition—is entirely absent. Without entitlements computation, retrieval, caching, and administrative overrides, micro-apps cannot verify user access. Products/Prices catalog is missing, preventing association of Stripe prices with features. Reconciliation and metrics are required for production operations but not implemented. Recommended next steps: 1) Implement Entitlement model and computation engine merging subscriptions, purchases, and manual grants, 2) Add GET /api/v1/entitlements endpoint with caching, 3) Create Product and Price models with feature code metadata, 4) Implement admin grant/revoke endpoints with audit trail, 5) Add scheduled reconciliation job, 6) Implement Redis caching with invalidation on webhook events, 7) Fix readiness check to verify database connectivity, 8) Add basic metrics endpoints. Current state supports payment processing but cannot serve as system of record for entitlements as specified.

After completing these tasks, rerun docker compose build, lint, typecheck, and tests, then provide updated evidence.
