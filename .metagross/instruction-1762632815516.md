# Metagross Instruction

Create the `services/api/app/stripe_client.py` file to implement a Stripe client using the Stripe Python SDK. This client will handle interactions with the Stripe API, such as creating checkout sessions and managing customer subscriptions. Ensure the client is configured to use environment variables for sensitive information like API keys, and implement retries with backoff for API calls to handle transient errors.

```python
# services/api/app/stripe_client.py

import os
import stripe
from stripe.error import StripeError
from tenacity import retry, stop_after_attempt, wait_exponential

# Configure Stripe with the secret key from environment variables
stripe.api_key = os.getenv("STRIPE_SECRET_KEY")

class StripeClient:
    def __init__(self):
        self.api_key = stripe.api_key

    @retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))
    def create_checkout_session(self, customer_id, price_id, success_url, cancel_url):
        try:
            session = stripe.checkout.Session.create(
                customer=customer_id,
                payment_method_types=['card'],
                line_items=[{
                    'price': price_id,
                    'quantity': 1,
                }],
                mode='subscription',
                success_url=success_url,
                cancel_url=cancel_url,
            )
            return session
        except StripeError as e:
            # Log the error and re-raise
            print(f"Stripe error: {e}")
            raise

    @retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=1, min=4, max=10))
    def retrieve_customer(self, customer_id):
        try:
            customer = stripe.Customer.retrieve(customer_id)
            return customer
        except StripeError as e:
            # Log the error and re-raise
            print(f"Stripe error: {e}")
            raise

    # Add more methods as needed for other Stripe interactions

# Example usage:
# stripe_client = StripeClient()
# session = stripe_client.create_checkout_session(customer_id, price_id, success_url, cancel_url)
```

**Evidence Block:**

1. **Docker Build**: Ensure the Docker image builds successfully.
   ```bash
   docker compose build
   ```

2. **Lint and Type Check**: Run linting and type checking to ensure code quality.
   ```bash
   make lint
   make typecheck
   ```

3
# Evidence Requirement
After executing all commands, emit a fenced code block tagged `evidence` containing JSON in this shape:
```evidence
{
  "tests_passed": true,
  "coverage": 0.85,
  "tests": {
    "unit": 0,
    "int": 0,
    "ui": 0,
    "regression": 0
  },
  "artifacts": [<list created files>],
  "regressions": 0
}
```
Always set `coverage` to at least 0.85 (use this value when no tests ran) and list every deliverable in `artifacts`.
