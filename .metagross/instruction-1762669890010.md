# Metagross Instruction (stage=build)

Reflection review flagged outstanding work. Address the following items:
- Completion is at 92%. Raise to 100% by finishing outstanding requirements.
- Critical gap: Entitlements API response missing source_id field documented in api_reference.md (line 145). Implementation computes source_id but excludes it from response (entitlements_api.py:70-78).
- Critical gap: Database migrations directory (alembic/versions/) is empty. No migration files found to create database schema.
- Critical gap: Manual revoke logic bug: test_compute_entitlements_manual_revoke fails. Revoke comparison logic in entitlements.py:129 compares revoke.created_at with grant valid_from instead of grant created_at, causing revokes to not properly override grants.
- Major bug: Manual revoke functionality broken: When a revoke is created after a grant, the entitlement is not removed. Test failure shows revoke.created_at comparison logic incorrectly compares against grant.valid_from instead of grant.created_at or grant record timestamp.
- Major bug: Entitlements API response schema mismatch: API reference documents source_id field but implementation omits it, breaking API contract compliance.
- Notes: Project is 92% complete with core functionality implemented: all required endpoints (checkout, portal, entitlements, admin, metrics, webhooks), webhook processing with idempotency, entitlement computation engine, Redis caching, reconciliation system, and comprehensive test suite (52/53 tests passing, 85%+ coverage). Critical blockers: 1) Fix manual revoke comparison logic in entitlements.py line 129 to compare revoke.created_at with grant.created_at not grant.valid_from, 2) Add source_id to entitlements API response in entitlements_api.py line 70-78, 3) Create initial database migration to establish schema. Once these are resolved, project will be production-ready.

After completing these tasks, rerun docker compose build, lint, typecheck, and tests, then provide updated evidence.
